# 1、 概述

## 1.openfeign是什么

openfeign是一个声明式的Web服务客户端，让编写Web服务客户端变得非常容易，只需要创建一个接口并在接口上添加注解即可

## 2.openfeign作用

openfeign可以定义和实现依赖服务接口的定义，只需要创建一个接口并使用注解的方式来配置它，即可完成对服务提供方的接口绑定，简化了使用springcloud ribbon时，自动封装服务调用客户端的开发量。

# 2、使用

## 1.pom依赖

```xml
<dependencies>
    <dependency>
        <groupId>com.he.springcloud</groupId>
        <artifactId>cloud-api-commons</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-openfeign</artifactId>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-devtools</artifactId>
        <scope>runtime</scope>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
        <exclusions>
            <exclusion>
                <groupId>org.junit.vintage</groupId>
                <artifactId>junit-vintage-engine</artifactId>
            </exclusion>
        </exclusions>
    </dependency>
</dependencies>
```

## 2.yml配置

```yml
server:
  port: 80

eureka:
  client:
    register-with-eureka: false
    com.he.springcloud.service-url:
      defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka

```

## 3.主启动类加注解

主启动类上加@EnableFeignClients来开启OpenFeign的注解

```java
//开启OpenFeign的注解
@EnableFeignClients
@SpringBootApplication
public class CloudConsumerFeignOrder80Application {

    public static void main(String[] args) {
        SpringApplication.run(CloudConsumerFeignOrder80Application.class, args);
    }

}

```

## 4.编写业务接口

业务接口内的抽象方法和要调用的服务端的Controller内的方法头一样，只是要返回的类型不同

接口要加@FeignClient，接口后的括号要加上要调用的微服务注册名

```java
@Component
//要调用的地微服务名称
@FeignClient("CLOUD-PAYMENT-SERVICE")
public interface PaymentFeignService {

    @PostMapping(value = "/payment/create")
    public CommonResult create(@RequestBody Payment payment);

    @GetMapping(value = "/payment/get/{id}")
    public CommonResult getPaymentById(@PathVariable("id") long id);

}
```

## 5.编写Controller

将服务接口注入进来，然后按照一般形式写方法头，方法体内直接调用业务接口的方法即可实现服务的调用

```java
@RestController
@Slf4j
public class OrderFeignController {

    @Resource
    private PaymentFeignService paymentFeignService;

    @GetMapping("/consumer/payment/get/{id}")
    public CommonResult<Payment> getPaymentById(@PathVariable("id") Long id){
        return paymentFeignService.getPaymentById(id);
    }

}
```

## 6.负载均衡

由于OpenFeign集成了Ribbon，所以OpenFeign自带负载均衡

# 3、超时控制

## 1.超时演示

### 1.服务端超时方法

```java
    @GetMapping("/payment/timeout")
    public String paymentTimeout(){
        try {
            Thread.sleep(10);
        }catch (Exception e){
            e.printStackTrace();
        }
        return ServerPort;
    }
```

然后客户端调用服务端超时方法

### 2.超时结果

![image-20201120101700015](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201120101700015.png)

## 2.开启openfeign超时配置

```yml
ribbon:
  #  建立连接使用时间，适用于网络状态正常的情况下，两端连接使用的时间
  ReadTimeout: 10000
  #  指的是建立连接之后从服务器读取到可用资源所用时间
  ConnectTimeout: 10
```

# 4、日志打印

## 1.日志级别

1. NONE：默认的，不显示任何日志
2. BASIC：仅记录请求方法、URL、响应状态码及执行时间
3. HEADERS：除了BASIC中定义的信息之外，还有请求和响应的头信息
4. FULL：除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据

## 2.编写日志配置类

```java
@Configuration
public class FeignConfig {

    @Bean
    Logger.Level feignLoggerLevel(){
        return Logger.Level.FULL;
    }

}
```

## 3.修改yml文件

```yml
logging:
  level:
#    feign以什么级别监控哪个接口
    com.he.springcloud.service.PaymentFeignService: debug
```

## 4.打印的日志

![image-20201120105322030](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201120105322030.png)