# 1、概述

## 1.简介

提供了一套完整的服务跟踪的解决方案，并且兼容支持zipkin，用于解决请求链路过于复杂的问题，可以获得每一个链路调用完整的轨迹图

# 2、安装zipkin

## 1.下载地址

https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/

## 2.运行

用java -jar的方式运行

## 3.访问管理界面

[Zipkin - Index](http://localhost:9411/zipkin/)

![image-20201205105740292](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201205105740292.png)

# 3、服务提供者

## 1.修改原有模块

修改cloud-provider-payment8001

## 2.引入pom依赖

```xml
<!--包含了sleuth+zipkin-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-zipkin</artifactId>
</dependency>
```

## 3.修改yml

```yml
spring:
  application:
    name: cloud-payment-service
  zipkin:
    base-url: http://localhost:9411
  sleuth:
    sampler:
    #采样率值介于 0 到 1 之间，1 则表示全部采集
    probability: 1
```

## 4.添加业务方法

```java
@GetMapping("/payment/zipkin")
public String paymentZipkin(){
    return "这个是paymentZipkin";
}
```

# 4、服务消费者

## 1.修改原有模块

修改cloud-consumer-order80

## 2.引入pom依赖

```xml
<!--包含了sleuth+zipkin-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-zipkin</artifactId>
</dependency>
```

## 3.修改yml

```yml
spring:
  application:
    name: cloud-payment-service
  zipkin:
    base-url: http://localhost:9411
  sleuth:
    sampler:
    #采样率值介于 0 到 1 之间，1 则表示全部采集
    probability: 1
```

##  4.添加业务方法

```java
    @GetMapping("/consumer/payment/zipkin")
    public String paymentZipkin(){
        return restTemplate.getForObject(PAYMENT_URL+"/payment/zipkin",String.class);
    }
```

# 5、测试

## 1.连续访问[localhost/consumer/payment/zipkin](http://localhost/consumer/payment/zipkin)

## 2.访问[Zipkin - Index](http://localhost:9411/zipkin/)查看结果

![image-20201205150640819](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201205150640819.png)

处理的所有请求

![image-20201205150659390](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201205150659390.png)

每个请求链路的具体信息

![image-20201205150733030](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201205150733030.png)

微服务之间的依赖分析