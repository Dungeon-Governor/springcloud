# 1、概述

## 1.简介

springcloud bus配合springcloud config使用可以实现配置的动态刷新

springcloud bus是用来将分布式系统的节点与轻量级消息系统连接起来的框架，整合了java的事件处理机制和消息中间件的功能

springcloud bus目前支持RabbitMQ和Kafka

## 2.作用

springcloud bus能管理和传播分布式系统间的消息，就像一个分布式执行器，可以用于广播状态更改、事件推送等，也可以当做微服务间的通信通道

## 3.什么是总线

在为服务架构的系统中，通常会使用轻量级的消息代理来构建一个共用的消息主题，并让系统中的所有微服务实例都连接上来，由于该主题中生产的消息会被所有的实例监听和消费，所有它被称为消息总线

## 4.bus总线基本原理

ConfigClient实例都监听一个topic（默认是bus），当一个服务刷新数据的时候，他会把这个信息放入topic中，主要其他监听同一个topic的服务就都能得到通知，然后更新自身的配置

# 2、RabbitMQ环境配置

## 1.安装Erlang

[下载地址：Erlang Solutions (erlang-solutions.com)](https://www.erlang-solutions.com/resources/download.html)

## 2.安装RabbitMQ

下载地址：[Release RabbitMQ 3.7.14 · rabbitmq/rabbitmq-server (github.com)](https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.7.14)

## 3.启动管理功能

在RabbitMQ安装目录的sbin文件夹下打开命令行窗口，执行

```shell
rabbitmq-plugins enable rabbitmq_management
```

安装可视化插件

## 4.启动测试

### 1.启动RabbitMQ

### 2.访问localhost:15672访问管理页面

### 3.登陆，默认账号和密码都是guest

![image-20201202164141548](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201202164141548.png)

登陆成功

# 3、bus实现动态刷新的全局广播

## 1.新建一个config客户端

和config分布式配置中心步骤一致，不同的是业务类进行了些修改，可以显示服务端口号

```java
@Value("${server.port}")
private String serverPort;

@Value("${config.info}")
private String configInfo;

@GetMapping("/configInfo")
public String getConfigInfo(){
    return "serverPort:"+serverPort+"\t\n\nconfigInfo:"+configInfo;
}
```

## 2.实现逻辑

利用消息总线触发一个服务端的/bus/refresh端点，而刷新所有客户端的配置

## 3.给服务端添加消息总线支持

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bus-amqp</artifactId>
</dependency>
```

## 4.在服务端添加rabbitmq配置

在服务端的yml配置文件添加以下配置信息

```yml
spring:
#  rabbitmq相关配置
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest

#暴露bus刷新配置端点
management:
  endpoints:
    web:
      exposure:
        include: "bus-refresh"
```

## 5.在客户端添加消息总线支持

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bus-amqp</artifactId>
</dependency>
```

## 6.在客户端添加rabbitmq配置

```yml
spring:
#  rabbitmq相关配置
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
```

## 7.修改github上的配置，并发送post请求

发送post请求http://localhost:3344/actuator/bus-refresh

![image-20201202172224065](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201202172224065.png)

![image-20201202172318025](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201202172318025.png)

服务端获取到了修改后的内容

![image-20201202172343612](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201202172343612.png)

![image-20201202172351851](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201202172351851.png)

可以看到3355和3366的版本信息都是10，说明bus刷新成功，只发送了一条命令就使所有的客户端刷新成功

# 4、bus实现动态刷新的定点通知

访问http://localhost:3344/actuator/bus-refresh/config-client:3355

![image-20201204102553800](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201204102553800.png)

就可以实现只通知config-client微服务的3355端口号进行刷新

![image-20201204102608539](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201204102608539.png)

![image-20201204102615012](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201204102615012.png)

![image-20201204102621368](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201204102621368.png)

可以看到，客户端中只有3355的version变成12了，3366的还是11，定点刷新成功