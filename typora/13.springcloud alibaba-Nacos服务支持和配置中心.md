# 1、概述

## 1.简介

一个更易于构建云原生应用的动态服务发现、管理配置和服务管理平台

是注册中心和配置中心的组合，类似于Eureka+Config+Bus

## 2.springcloud alibaba中文文档

[spring-cloud-alibaba/README-zh.md at master · alibaba/spring-cloud-alibaba · GitHub](https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md)

## 3.安装Nacos

### 1.下载地址

[Releases · alibaba/nacos · GitHub](https://github.com/alibaba/nacos/releases)

### 2.安装并运行

解压到任意目录，运行bin目录下的startup.cmd即可运行

### 3.访问管理页面

[Nacos](http://127.0.0.1:8848/nacos)

![image-20201205160424402](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201205160424402.png)

用户名和密码都是是nacos

![image-20201205160558515](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201205160558515.png)

登陆后页面

# 2、作为注册中心

## 1.服务提供者

### 1.新建模块

cloudalibaba-provider-payment9001

### 2.pom依赖

#### 父工程pom依赖

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-dependencies</artifactId>
    <version>2.1.0.RELEASE</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```

#### 子工程pom依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>com.he.springcloud</groupId>
    <artifactId>cloud-api-commons</artifactId>
    <version>0.0.1-SNAPSHOT</version>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-devtools</artifactId>
    <scope>runtime</scope>
    <optional>true</optional>
</dependency>
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <optional>true</optional>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
    <exclusions>
        <exclusion>
            <groupId>org.junit.vintage</groupId>
            <artifactId>junit-vintage-engine</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

### 3.yml配置

```yml
# 应用服务 WEB 访问端口
server:
  port: 9001

# 应用名称
spring:
  application:
    name: cloudalibaba-provider-payment9001
# Nacos 服务发现与注册配置，其中子属性 server-addr 指定 Nacos 服务器主机和端口
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848

# Actuator Web 访问端口
management:
  endpoints:
    jmx:
      exposure:
        include: "*"
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always
```

### 4.在主启动类加注解

```java
//开启服务发现功能
@EnableDiscoveryClient
```

### 5.业务类

```java
@RestController
@Slf4j
public class PaymentController {

    @Value("${server.port}")
    private String serverPort;

    @GetMapping("/payment/nacos/{id}")
    public String getPayment(@PathVariable("id") Integer id){
        return "nacos registry,serverPort："+serverPort+"\t,id："+id;
    }

}
```

### 6.测试

启动微服务

访问127.0.0.1:8848/nacos

![image-20201205164229072](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201205164229072.png)

微服务监控信息

## 2.服务消费者

### 1.新建模块

cloudalibaba-consumer-order83

### 2.pom依赖

#### 父工程pom依赖

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-dependencies</artifactId>
    <version>2.1.0.RELEASE</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```

#### 子工程pom依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>com.he.springcloud</groupId>
    <artifactId>cloud-api-commons</artifactId>
    <version>0.0.1-SNAPSHOT</version>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-devtools</artifactId>
    <scope>runtime</scope>
    <optional>true</optional>
</dependency>
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <optional>true</optional>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
    <exclusions>
        <exclusion>
            <groupId>org.junit.vintage</groupId>
            <artifactId>junit-vintage-engine</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

### 3.yml配置

```yml
# 应用服务 WEB 访问端口
server:
  port: 83

# 应用名称
spring:
  application:
    name: cloudalibaba-consumer-order83
  # Nacos 服务发现与注册配置，其中子属性 server-addr 指定 Nacos 服务器主机和端口
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848

#消费者将要去访问的微服务提供者名称
service-url:
  nacos-user-service: http://cloudalibaba-provider-payment

```

### 4.在主启动类加注解

```java
//开启服务发现功能
@EnableDiscoveryClient
```

### 5.配置RestTemplate

```java
@Configuration
public class ApplicationContextConfig {

    @Bean
//    开启负载均衡
    @LoadBalanced
    public RestTemplate getRestTemplate(){
        return new RestTemplate();
    }

}
```

### 6.业务类

```java
@RestController
@Slf4j
public class OrderNacosController {

    @Resource
    private RestTemplate restTemplate;

    @Value("${service-url.nacos-user-service}")
    private String serverUrl;

    @GetMapping("/consumer/payment/nacos/{id}")
    public String paymentInfo(@PathVariable("id") Long id){
        return restTemplate.getForObject(serverUrl+"/payment/nacos/"+id,String.class);
    }

}
```

### 

## 3.负载均衡

nacos集成了ribbon，所以支持负载均衡

### 1.模仿9001新建9002

也可以根据9001拷贝虚拟端口映射

![image-20201205165250860](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201205165250860.png)

![image-20201205165231815](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201205165231815.png)

### 2.测试

![image-20201207155052482](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201207155052482.png)

![image-20201207155102941](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201207155102941.png)

负载均衡采用轮询算法，成功

## 4.AP和CP模式切换

nacos既支持AP模式，也支持CP模式，可以根据需要进行切换，C是所有节点在同一时间看到的数据是一致的，而A的定义是所有请求都会收到响应、

如果不需要存储服务级别的信息，就是用AP模式，如果需要在服务级别编辑或者存储配置信息，就需要使用CP模式

### 切换方法

发送put请求

nacos_server:8848/nacos/v1/ns/operator/switches?entry=serverMode&value=CP

# 3、作为配置中心

## 1.基础配置

### 1.新建模块

cloudalibaba-config-nacos-client3377

### 2.pom依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-devtools</artifactId>
    <scope>runtime</scope>
    <optional>true</optional>
</dependency>
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <optional>true</optional>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
    <exclusions>
        <exclusion>
            <groupId>org.junit.vintage</groupId>
            <artifactId>junit-vintage-engine</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

### 3.yml配置

#### bootstrap.yml

```yml
server:
  port: 3377

# Nacos认证信息
spring:
  application:
    name: nacos-config-client
  cloud:
    nacos:
      discovery: 
        server-addr:127.0.0.1:8848
      config:
        # 设置配置中心服务端地址
        server-addr: 127.0.0.1:8848
        file-extension: yaml
```

#### application.yml

```
spring:
  profiles:
    active: dev  #表示开发环境
```

### 4.主启动类加注解

@EnableDiscoveryClient

### 5.业务类

```java
@RestController
//开启nacos的动态刷新功能
@RefreshScope
public class ConfigClientController {

    @Value("${config.info}")
    private String configInfo;

    @GetMapping("/config/info")
    public String getConfigInfo(){
        return configInfo;
    }

}
```

## 2.根据dataId编写配置文件

dataId完整格式

```yml
${prefix}-${spring.profile.active}.${file-extension}
```

prefix的值为spring.application.active的值

spring.profile.active的值为当前环境对应的profile的值，对应spring.profiles.active

file-extension为配置文件的格式，目前只支持properties和yaml，对应spring.cloud.nacos.config.file-extension

![image-20201208102208257](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208102208257.png)

在nacos根据dataId编写配置文件

### 测试

访问localhost:3377/config/info

![image-20201208104753285](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208104753285.png)

读取成功

### nacos可以动态刷新配置文件

![image-20201208105015052](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208105015052.png)

更改配置文件后刷新成功

## 3.分类配置

### 1.分类依据

nacos是按照namespace+group+dataid的格式进行分类的

namespace默认值是public，是用来区分环境的

group默认值是DEFAULT_GROUP，可以把不同的微服务划分到同一个分组里

### 2.dataId方案

#### 建立test配置文件

在nacos-config-client-dev.yaml的基础上建立nacos-config-client-test.yaml

#### 通过spring.profiles.active读取多环境配置文件

将spring.profiles.active的值从dev改为test即可

![image-20201208110639128](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208110639128.png)

更换成功

### 3.group方案

#### 新建info配置文件

![image-20201208111304604](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208111304604.png)

通过添加修改group的值就可以实现切换效果

```yml
# Nacos认证信息
spring:
  application:
    name: nacos-config-client
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
      config:
#        设置配置中心服务端地址
        server-addr: 127.0.0.1:8848
        file-extension: yaml
        group: DEV_GROUP
```

#### 测试

![image-20201208112155639](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208112155639.png)

![image-20201208112235809](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208112235809.png)

### 4.namespace方案

#### 新建dev/test的namespace

![image-20201208112829832](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208112829832.png)

通过添加修改namespace的值就可以实现切换效果，填的是命名空间的id

```yml
# Nacos认证信息
spring:
  application:
    name: nacos-config-client
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
      config:
#        设置配置中心服务端地址
        server-addr: 127.0.0.1:8848
        file-extension: yaml
        group: TEST_GROUP
        namespace: 2ddb7be0-4c1e-4932-a6b5-b64dabcfc3e5
```

在dev新建几个配置文件

![image-20201208113521471](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208113521471.png)

#### 测试

![image-20201208113639674](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208113639674.png)

切换完成

# 4、nacos集群和持久化配置

## 1.概念

### nacos集群

概念图

![image-20201208115226410](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208115226410.png)

请求先通过一个nginx集群，进入nacos集群进行处理，nacos的配置文件全部存储到一个mysql集群

### nacos持久化配置

nacos内置一个嵌入式的数据库derby，nacos的配置文件都会存储到derby中

nacos集群中，每一个nacos都有一个内置的数据库，会导致nacos集群之间配置文件的不统一

未解决这一问题，我们需要将nacos的存储数据库从内置的derby切换成统一的一个mysql集群

## 2.切换到mysql

在nacos的安装目录的conf目录下，有个nacos-mysql.sql脚本，在数据库执行脚本

同目录下有application.properties文件，需要在里面添加数据库的配置

spring.datasource.platform=mysql

```text

#*************** Config Module Related Configurations ***************#
### If use MySQL as datasource:
spring.datasource.platform=mysql

### Count of DB:
db.num=1

### Connect URL of DB:
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useUnicode=true&useSSL=false&serverTimezone=UTC
db.user=root
db.password=root
```

## 3.安装linux版

### 1.修改application.properties

#*************** Config Module Related Configurations ***************#
### If use MySQL as datasource:
spring.datasource.platform=mysql

### Count of DB:
db.num=1

### Connect URL of DB:
```
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useUnicode=true&useSSL=false&serverTimezone=UTC
db.user=root
db.password=root
```

### 2.修改cluster.conf

ip填hostname -I执行后显示的第一个ip地址

```conf
172.29.146.70:8847
172.29.146.70:8848
172.29.146.70:8849
```

### 3.修改nacos的启动脚本

![image-20201208181310947](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208181310947.png)

添加图片中红框中的内容

倒数第二行添加下面的粗体部分

nohup $JAVA **-Dserver.port=${PORT}**${JAVA_OPT}  nacos.nacos >> ${BASE_DIR}/logs/start.out 2>&1 &

可以使用sh startup.sh -p 8847来运行8847端口的nacos

### 4.修改nginx配置

![image-20201208182230681](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201208182230681.png)

对nginx.conf完成图中的修改

```
upstream cluster{
	server 127.0.0.1:8847;
	server 127.0.0.1:8847;
	server 127.0.0.1:8847;
}
proxy_pass http://cluster
```

### 6.项目修改yml

将配置中心服务端地址和注册中心服务端地址都改为47.94.37.85:1111

### 5.测试

访问http://47.94.37.85:1111/nacos就可以登陆nacos的管理界面

查看节点列表

![image-20201209114229486](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201209114229486.png)

可以看到有三个在线节点

![image-20201209115449778](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201209115449778.png)

微服务也注册成功

![image-20201209115637645](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201209115637645.png)

数据库中存有配置中心的配置内容

![image-20201209115514258](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201209115514258.png)

微服务也能读取配置中心的配置