# 1、Consul简介

Consul是一套开源的分布式服务发现和配置管理系统，由go语言开发，提供了一种完整的服务网格解决方案

# 2、下载及安装

## 1.下载

来consul中文文档下载https://kingfree.gitbook.io/consul/，下载之后是个exe文件

## 2.运行

在有consul.exe的文件目录下运行cmd，执行consul agent -dev即可，在浏览器访问localhost:8500端口即可访问consul管理页面

# 3、将支付模块注册进consul

## 1.模块的pom依赖

```xml
<dependencies>
    <dependency>
        <groupId>com.he.springcloud</groupId>
        <artifactId>cloud-api-commons</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-consul-discovery</artifactId>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-devtools</artifactId>
        <scope>runtime</scope>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
        <exclusions>
            <exclusion>
                <groupId>org.junit.vintage</groupId>
                <artifactId>junit-vintage-engine</artifactId>
            </exclusion>
        </exclusions>
    </dependency>
</dependencies>
```

## 2.配置yml文件

```yml
server:
  port: 8006
spring:
  application:
    name: consul-provider-payment
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        com.he.springcloud.service-name: ${spring.application.name}
```

## 3.主启动类加注解

加上@EnableDiscoveryClient注解

```java
@EnableDiscoveryClient
@SpringBootApplication
public class CloudProviderconsulPayment8006Application {

    public static void main(String[] args) {
        SpringApplication.run(CloudProviderconsulPayment8006Application.class, args);
    }

}
```

## 4.写controller

```java
@RestController
@Slf4j
public class PaymentController {

    @Value("${server.port}")
    private String ServerPort;

    @GetMapping("/payment/consul")
    public String paymentConsul(){
        return "springcloud with consul"+ServerPort+"\t"+ UUID.randomUUID().toString();
    }

}
```

# 4、将订单模块注册进consul

## 1.新建项目的pom文件

需要引入的pom依赖

```xml
<dependencies>
        <dependency>
            <groupId>com.he.springcloud</groupId>
            <artifactId>cloud-api-commons</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-consul-discovery</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
            <exclusions>
                <exclusion>
                    <groupId>org.junit.vintage</groupId>
                    <artifactId>junit-vintage-engine</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
    </dependencies>
```

## 2.编写yml文件

```yml
server:
  port: 8006
spring:
  application:
    name: consul-provider-payment
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        com.he.springcloud.service-name: ${spring.application.name}
```

## 3.在主启动类开启注解

添加@EnableDiscoveryClient注解，该注解用于向consul和zookeeper作为注册中心时注册服务

```java
@EnableDiscoveryClient
@SpringBootApplication
public class CloudConsumerconsulOrder80Application {

    public static void main(String[] args) {
        SpringApplication.run(CloudConsumerconsulOrder80Application.class, args);
    }

}
```

## 4.创建RestTemplate配置类

```java
@Configuration
public class ApplicationContextConfig {

    @Bean
//    赋予RestTemplate负载均衡的能力
    @LoadBalanced
    public RestTemplate getRestTemplate(){
        return new RestTemplate();
    }

}
```

## 5.编写controler

地址那填的微服务名称不同于eureka的全大写，这个是按照配置文件原本名称来的

```java
@RestController
@Slf4j
public class OrderController {

    public static final String INVOKE_URL = "http://consul-provider-payment";

    @Resource
    private RestTemplate restTemplate;

    @GetMapping("/consumer/payment/consul")
    public String paymentInfo(){
        return restTemplate.getForObject(INVOKE_URL+"/payment/consul",String.class);
    }

}
```

# 5、consul集群

和eureka类似

# 6、三种注册中心的同异点

![image-20201117203631816](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201117203631816.png)

## CAP概念

- C：强一致性
- A：可用性
- P：分区容错性

CAP理论关注粒度是数据，而不是整体系统设计的 策略

## CAP概念图

![image-20201117203913317](https://raw.githubusercontent.com/Dungeon-Governor/images/master/img/image-20201117203913317.png)

CAP理论的核心是：一个分布式系统不可能同时很好的满足一致性、可用性和分区容错性这三个需求，最多只能同时较好的满足两个。

AP：满足可用性，分区容忍性的系统，通常可能对一致性要求低一些

CP：满足一致性，分区容忍性的系统，通常性能不是特别高

## AP框架（Eureka）

当网络分区出现后，为了保证可用性，系统可以返回旧值，保证系统的可用性

## CP框架（Zookeeper/Consul）

当网络分区出现后，为了保持一致性，就必须拒绝请求，否则无法保持一致性